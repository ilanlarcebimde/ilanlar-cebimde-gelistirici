---
description: profiles tablosu SABİT; kayıt sadece PayTR/kupon sonrası. n8n webhook %100 tetiklenir, idempotent, events ile izlenir.
alwaysApply: true
---

# CURSOR AI — profiles SABİT, webhook %100 tetiklenmesi

## NON-NEGOTIABLE (TABLOYU VE KAYIT MANTIĞINI BOZMA)

- Supabase `profiles` tablosunun şemasına ve kayıt mantığına **asla dokunma**.
- **profiles'a yazma kuralı:** Profil verisi **yalnızca** şu iki durumda oluşturulur/yazılır:
  1) **PayTR ödemesi başarıyla doğrulandığında** (callback),
  2) **ADMIN549 kuponu** ile tamamlandığında (complete-coupon).
- Form/sihirbaz bitince profiles'a yazma **yok**; bu kuralı bozacak değişiklik yapma.
- `is_cv_sent` alanı **yalnızca n8n** tarafından yönetilir; uygulama bu alana yazmaz.
- profiles kolonları/tipleri/yapısı değiştirilmez.

---

## HEDEF

- PayTR success veya kupon completion sonucu profiles'a kayıt yazıldıktan **hemen sonra** n8n production webhook **kesin** tetiklensin.
- Webhook tetiklenmese bile olay kaybolmasın; **events** tablosunda iz bırak (n8n_webhook_failed, n8n_webhook_skipped_*).
- PayTR callback retry/duplicate olduğunda webhook spam olmasın (**idempotent**: sadece ilk "started -> success" geçişinde webhook çağrılır).

---

## N8N WEBHOOK (DEĞİŞTİRME)

- **URL:** `process.env.N8N_CV_WEBHOOK_URL` (örn. https://xxx.rcld.app/webhook/xxx)
- **Method:** GET
- **Query params:** profile_id (UUID, zorunlu), payment_id (PayTR: merchant_oid, kupon: "coupon"), status="success", ts=ISO

---

## UYGULAMA KURALLARI

### PayTR callback (src/app/api/paytr/callback/route.ts)

- Girişte log: merchant_oid, status.
- Success branch'te **idempotency:** Sadece `payments` tablosunda `status = 'started'` olan satırı `status = 'success'` yap; bu update **atomik** olsun ve dönen satırı kullan. Update 0 satır döndürürse (zaten işlenmiş) webhook çağırma, 200 OK dön.
- profileId: profile_snapshot varsa profiles insert yap ve yeni id al; yoksa mevcut profile_id kullan. profileId geçerli UUID değilse events'e `n8n_webhook_skipped_invalid_profile` yaz, 200 OK dön.
- Webhook çağrısında **response kontrolü zorunlu:** res.ok değilse veya fetch throw ederse events'e `n8n_webhook_failed` yaz (payload: merchant_oid, status/body veya error).
- N8N_CV_WEBHOOK_URL boşsa events'e `n8n_webhook_skipped_missing_env` yaz.
- **PayTR'ye her durumda 200 OK dön** (webhook hata verse bile retry tetiklenmesin).

### Kupon (src/app/api/profile/complete-coupon/route.ts)

- profiles insert başarılı olduktan sonra webhook çağır.
- fetch response status logla; res.ok değilse veya throw ise events'e `n8n_webhook_failed` yaz (payment_id: "coupon").
- Webhook URL boşsa events'e `n8n_webhook_skipped_missing_env` yaz.

### ENV

- Production'da (Vercel) **N8N_CV_WEBHOOK_URL** kesin dolu olmalı. Callback/coupon içinde boşsa events'e yazılıyor.

---

## KABUL KRİTERLERİ

- PayTR success'te profiles kaydı tamamlanınca webhook çağrısı kesin çalışır (n8n executions oluşur).
- Aynı merchant_oid tekrar gelirse webhook tekrar çağrılmaz (idempotent).
- Kupon ile profiles insert sonrası webhook çağrısı kesin çalışır.
- Webhook başarısızsa kaybolmaz; events tablosunda `n8n_webhook_failed` görülür.
- profiles tablosuna/şemasına asla dokunulmaz; kayıt mantığı (sadece PayTR/kupon sonrası) korunur.
